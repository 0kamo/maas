#!/usr/bin/make -f

BUILDHOME = $(CURDIR)/debian/build
PYTHON = $(shell pyversions -d)
# Python enum modules.
py_enums := $(wildcard src/*/enum.py)

%:
	dh $@ --with python2,apport,systemd --buildsystem=python_distutils

override_dh_installinit:
	# maas-clusterd
	dh_systemd_enable --name maas-clusterd
	dh_installinit --name maas-clusterd
	dh_systemd_start --name maas-clusterd
	# maas-regiond
	dh_systemd_enable --name maas-regiond
	dh_installinit --name maas-regiond
	dh_systemd_start --name maas-regiond
	# maas-regiond-worker
	dh_installinit --name maas-regiond-worker  # Upstart
	dh_installinit --name maas-regiond-worker@  # systemd
	# maas-dhcpd
	dh_systemd_enable --name maas-dhcpd
	dh_installinit --name maas-dhcpd
	dh_systemd_start --name maas-dhcpd
	# maas-dhcpd6
	dh_systemd_enable --name maas-dhcpd6
	dh_installinit --name maas-dhcpd6
	dh_systemd_start --name maas-dhcpd6
	# maas-proxy
	dh_systemd_enable --name maas-proxy
	dh_installinit --name maas-proxy
	dh_systemd_start --name maas-proxy

override_dh_auto_build:
	dh_auto_build

	mkdir -p $(BUILDHOME)
	HOME=$(BUILDHOME) PYTHONPATH=$(CURDIR)/src/ $(PYTHON)	\
		$(CURDIR)/src/maasserver/utils/jsenums.py	\
		$(py_enums) > $(BUILDHOME)/enums.js

override_dh_auto_install:
	dh_auto_install

	# Move static files
	install -d -m 755  $(CURDIR)/debian/tmp/usr/share/maas/web/static
	mv $(CURDIR)/debian/tmp/usr/lib/python*/*-packages/maasserver/static \
                $(CURDIR)/debian/tmp/usr/share/maas/web/

	# Remove scss directory from static files
	rm -rf $(CURDIR)/debian/tmp/usr/share/maas/web/scss

	# Install built enums.js file.
	cp $(BUILDHOME)/enums.js $(CURDIR)/debian/tmp/usr/share/maas/web/static/js/

	# install the apparmor profile
	install -d -m 755 $(CURDIR)/debian/tmp/etc/apparmor.d/dhcpd.d
	install -m 644 $(CURDIR)/debian/maas-dhcp.apparmor \
	    $(CURDIR)/debian/tmp/etc/apparmor.d/dhcpd.d/maas

	dh_install --list-missing

override_dh_auto_clean:
	dh_auto_clean
	rm -rf $(BUILDHOME)
	rm -rf src/*.egg-info

DEB_DEBIAN_DIR=$(dir $(firstword $(MAKEFILE_LIST)))
REV=$(shell dpkg-parsechangelog -l$(DEB_DEBIAN_DIR)/changelog \
              | sed -rne 's,^Version: .*[+~]bzr([0-9]+).*,\1,p')
VER=$(shell dpkg-parsechangelog -l$(DEB_DEBIAN_DIR)/changelog \
              | sed -rne 's,^Version: ([^-]+).*,\1,p')
get-orig-source:
	bzr export -r $(REV) --root=maas-$(VER).orig \
             maas_$(VER).orig.tar.gz lp:maas
