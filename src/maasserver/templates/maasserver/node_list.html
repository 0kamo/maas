{% extends "maasserver/base.html" %}

{% block nav-active-node-list %}active{% endblock %}
{% block title %}Nodes{% endblock %}
{% block page-title %}{{ paginator.count }}{% if input_query or input_test %} matching{% endif %} node{{ paginator.count|pluralize }} in {% include "maasserver/site_title.html" %}{% endblock %}
{% block header-search %}{% endblock %}

{% block html_includes %}{% include "maasserver/snippets.html" %}
{% endblock %}

{% block head %}
  <style type="text/css">
  #node_listing_form select {
      height: 33px;
      background: #fff;
      border-radius: 4px;
  }

  #node_listing_form select:focus {
      background: #fff;
      outline: none;
      outline-style:none;
      box-shadow:none;
  }

  #node_listing_form select option[value=""] {
      display:none;
  }

  input.search-input {
    line-height: 23px;
    outline: none;
  }
  </style>
  <script type="text/javascript">
  <!--
  YUI().use('maas.node_add', function (Y) {
    Y.on('load', function() {
      Y.one('#addnode').on('click', function(e) {
        var power_types = {{ power_types }};
        e.preventDefault();
        Y.maas.node_add.showAddNodeWidget({
            powerTypes: power_types,
            targetNode: '#nodes'
            });
      });
      // Reload the page when a new node gets added.
      Y.maas.node_add.AddNodeDispatcher.on(
        Y.maas.node_add.NODE_ADDED_EVENT, function(e) {
          window.location.reload();
      });
    });
  });
  // Connect the 'select all' checkbox to all the node checkboxes.
  YUI().use('node', function (Y) {
    Y.on('load', function() {
      var master = Y.one('#all_system_id_control');
      var nodelist = Y.one('table#node_list');
      if (Y.Lang.isValue(nodelist)) {
        var checkboxes = nodelist.all('input[name="system_id"]');
        // Uncheck the master checkbox if one of the row checkboxes gets
        // unchecked
        checkboxes.on('change', function(e) {
          var notChecked = checkboxes.filter('input:not(:checked)');
          master.set('checked', (notChecked.size() == 0));
        });
        // Check/uncheck all the row checkboxes if the master checkbox gets
        // checked/unchecked.
        master.on('change', function(e) {
          var checked = e.target.get('checked');
          checkboxes.set('checked', checked);
        });
      }
    });
  });
  // Reveal the zone widget only when the "set zone" action is selected.
  YUI().use('node', function (Y) {
    Y.on('domready', function() {
      var action_dropdown = Y.one('#id_action');
      var zone_widget = Y.one('#zone_widget');
      if (zone_widget === null || zone_widget === undefined) {
          return
      }

      function set_zone_widget_visibility() {
        if (action_dropdown.get('value') == 'set_zone') {
          zone_widget.removeClass('hidden');
        } else {
          zone_widget.addClass('hidden');
        }
      }

      action_dropdown.on('change', set_zone_widget_visibility);
      set_zone_widget_visibility();
    });
  });
  YUI().use(
    'maas.node', 'maas.node_views', 'maas.shortpoll',
    function (Y) {
    Y.on('domready', function() {
      if(!Y.Lang.isValue(Y.one('#node_list')))
        return;

      // Create the nodes reloader view.
      var view = new Y.maas.node_views.NodesTableReloader({
        srcNode: '#node_list'});

      // Create the query url, filtered by system_ids.
      var ids = view.getNodesList();
      var op_url = "";
      Y.Array.each(ids, function(id) {
        op_url += "&id=" + id;
      });
      if (op_url.length > 0) {
        op_url = "?" + op_url.substr(1);
      }

      // Start the poller.
      var poller = new Y.maas.shortpoll.ShortPollManager({
        uri: "{% url 'node-list' %}" + op_url
      });
      view.addLoader(poller.get("io"));
      poller.poll();
    });
  });
  // Submit the search form, when the search event is fired on the search box.
  YUI().use('node', function (Y) {
    Y.on('domready', function() {
      // on('search') does not work with YUI, so have to set the event
      // handler directly.
      var searchBox = Y.one('input[name="query"]');
      searchBox._node.onsearch = function() {
          Y.one("#node_listing_search_form").submit();
      };
    });
  });
  // -->
  </script>
{% endblock %}

{% block content %}
<div id="nodes" style="position: relative;">
    <form id="node_listing_search_form" action="{% url 'node-list' %}?{{preserved_query}}" method="get" class="search">
        <input type="search" name="query" placeholder="Search nodes" class="search-input" value="{{input_query|default_if_none:''}}" />
        <input id="search_button" type="submit" class="search-submit" />
    </form>
    <form id="node_listing_form" action="{% url 'node-list' %}?{{preserved_query}}" method="post">
        <div class="block full-width">
            {% csrf_token %}
            {{ form.action }}
            <input type="submit" value="Go" />
            {% if form.zone %}
            <div id="zone_widget" class="hidden">Set zone to:&nbsp;{{ form.zone }}</div>
            {% endif %}
            {% for field in form %}
                {% if field.errors %}
                <span class="errors">{{ field.errors }}</span>
                {% endif %}
            {% endfor %}
        </div>
        {% if input_query_error %}
        <p style="padding-top:10px;" class="form-errors">{{input_query_error}}</p>
        {% endif %}
        {% include "maasserver/nodes_listing.html" with sorting="true" actions="true"%}
        {% include "maasserver/pagination.html" %}
    </form>
    <a id="addnode" href="#" class="button right space-top">+ Add node</a>
    <a class="right space-top" href="{% url "enlist-preseed-view" %}">View enlistment preseed</a>
</div>
{% endblock %}
