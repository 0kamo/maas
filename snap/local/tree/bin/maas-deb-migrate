#!/bin/bash -e
#
# Copyright 2020 Canonical Ltd.  This software is licensed under the
# GNU Affero General Public License version 3 (see the file LICENSE).
#
#
# Perform migration from a deb setup to the snap.
#

SNAP_COMMON="/var/snap/maas/common"
SNAP_DATA="/var/snap/maas/current"
SNAP_MODE_FILE="$SNAP_COMMON/snap_mode"

is_installed() {
    dpkg-query -W -f'${Status}\n' "$1"  2>/dev/null | grep -q ^install
}

set_snap_mode() {
    local mode=""
    if is_installed maas-region-api; then
        mode="region"
    fi
    if is_installed maas-rack-controller; then
        [ -z "$mode" ] && mode="rack" || mode="region+rack"
    fi
    if  [ -n "$mode" ]; then
        echo "$mode" > "$SNAP_MODE_FILE"
    fi
}

get_snap_mode() {
    if [ -f "$SNAP_MODE_FILE" ]; then
        cat "$SNAP_MODE_FILE"
    fi
}

snap_run() {
    snap run --shell maas -c "$1"
}

clear_services() {
    local services="dhcpd dhcpd6 http proxy rackd regiond syslog"
    local service
    for service in $services; do
        clean_service "maas-$service.service"
    done
}

clean_service() {
    local service="$1"
    if [ -z "$DPKG_MAINTSCRIPT_PACKAGE" ]; then
        systemctl stop "$service" || true
        systemctl unmask "$service" || true
        find /etc/systemd /var/lib/systemd -type f -name "$service" -delete || true
    else
        deb-systemd-invoke stop "$service" || true
        deb-systemd-helper purge "$service" || true
        deb-systemd-helper unmask "$service" || true
    fi

}

migrate_data() {
    if [ -d /etc/maas ]; then
        cp -a /etc/maas/* "$SNAP_DATA"
    fi

    mkdir -p "$SNAP_DATA/var/lib"
    if [ -d /var/lib/maas ]; then
        mv /var/lib/maas "$SNAP_DATA/var/lib"
        chown -R root:root "$SNAP_DATA/var/lib/maas"

        mkdir -p "$SNAP_DATA/root"
        if [ -d "$SNAP_DATA/var/lib/maas/.ssh" ]; then
           mv "$SNAP_DATA/var/lib/maas/.ssh" "$SNAP_DATA/root"
        fi
    fi
    if [ -d /var/spool/maas-proxy ]; then
        mv /var/spool/maas-proxy/* "$SNAP_COMMON/proxy/spool/"
        chown -R snap_daemon:snap_daemon "$SNAP_COMMON/proxy/spool"
    fi
}

migrate_db() {
    if get_snap_mode | grep -q "region"; then
        snap_run "maas-region migrate"
    fi
}

cleanup_data() {
    rm -rf \
       /etc/bind/maas \
       /etc/maas \
       /etc/chrony/maas.conf \
       /run/lock/maas:* \
       /run/maas/ \
       /var/spool/maas-proxy
}

configure_supervisord() {
    /snap/bin/maas reconfigure-supervisord
}

set_snap_mode
clear_services
migrate_data
cleanup_data
migrate_db
configure_supervisord
