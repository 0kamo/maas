#!/bin/bash -e
#
# Copyright 2020 Canonical Ltd.  This software is licensed under the
# GNU Affero General Public License version 3 (see the file LICENSE).
#
#
# Migrates from a .deb-based MAAS install to a snap-based one.
#

# minimum version supported by the migration script
MAAS_MIN_DEB_VERSION="2.4.0"

SNAP_COMMON="/var/snap/maas/common"
SNAP_DATA="/var/snap/maas/current"


error_exit() {
    echo "$@" >&2
    exit 1
}

ask_yes_no() {
    local response=""
    while [ -z "$response" ]; do
        read -r -p "$* [Y/N]: " response
        case "$response" in
            Y|y) response="y" ;;
            N|n) response="n" ;;
            *) response="" ;;
        esac
    done
    echo "$response"
}

is_installed() {
    dpkg-query -W -f'${Status}\n' "$1" 2>/dev/null | grep -q ^install
}

maas_deb_version() {
    # The version for all MAAS packages is the same, so just grab the first one that
    # is installed
    dpkg-query -W -f'${Version}\n' maas-region-api maas-rack-controller 2>/dev/null \
        | head -n1
}

get_snap_mode() {
    cat "$SNAP_COMMON/snap_mode" 2>/dev/null || echo "none"
}

check_maas_installed() {
    local current_version
    current_version=$(maas_deb_version)
    if [ -z "$current_version" ]; then
        error_exit "No MAAS installation found."
    fi
    if dpkg --compare-versions "$current_version" "<<" "$MAAS_MIN_DEB_VERSION"; then
        error_exit "\
This MAAS version is not supported by this migration tool.
Please update MAAS to $MAAS_MIN_DEB_VERSION or later before migrating."
    fi
}

check_root() {
    if [ "$EUID" -ne 0 ]; then
        error_exit "This command must be run as root."
    fi
}

ensure_snap_unused() {
    local current_mode
    current_mode=$(get_snap_mode)
    [ "$current_mode" != "none" ] || return 0

    cat <<EOF
The MAAS snap is currently configured in "$current_mode".

To proceed with the migration, the snap installation must be cleared.
This will destroy all existing data in the snap.

EOF
    local answer
    answer=$(ask_yes_no "Proceed?")
    [ "$answer" != "n" ] || exit 0

    snap stop maas
    rm -rf \
       "$SNAP_DATA/var/lib/maas" \
       "$SNAP_DATA/root" \
       "$SNAP_COMMON/proxy/spool"
}

keep_database() {
    is_installed maas-region-controller || return 0
    rm -f /etc/dbconfig-common/maas-region-controller.conf
    debconf-communicate maas-region-controller <<EOF
SET maas-region-controller/dbconfig-remove false
FSET maas-region-controller/dbconfig-remove seen true
EOF
}

migrate_to_snap() {
    snap stop maas
    /snap/maas/current/bin/maas-deb-migrate
    snap start maas
}

cleanup_debs() {
    apt autoremove -y maas maas-region-api maas-rack-controller
}


check_root
check_maas_installed
ensure_snap_unused
migrate_to_snap
keep_database
cleanup_debs
