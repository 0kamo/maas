#!/bin/bash -e
# Copyright 2017 Canonical Ltd.  This software is licensed under the
# GNU Affero General Public License version 3 (see the file LICENSE).

# Create the required directories for services to run.
if [ ! -d "$SNAP_COMMON/log" ]; then
    mkdir -m 775 "$SNAP_COMMON/log"
    chown snap_daemon "$SNAP_COMMON/log"
fi
mkdir -p "$SNAP_COMMON/log/"{proxy,http}
mkdir -p "$SNAP_COMMON/proxy/"{cache,spool}

chown root:root "$SNAP_COMMON/log/http"
chown snap_daemon:snap_daemon "$SNAP_COMMON/log/proxy"
chown snap_daemon:snap_daemon "$SNAP_COMMON/proxy/"{cache,spool}
mkdir -p "$SNAP_DATA/root"
mkdir -p "$SNAP_DATA/preseeds"
mkdir -p "$SNAP_DATA/bind"
mkdir -p "$SNAP_DATA/proxy"
mkdir -p "$SNAP_DATA/syslog"
mkdir -p "$SNAP_DATA/supervisord"
mkdir -p "$SNAP_DATA/var/lib/maas"
mkdir -p "$SNAP_DATA/var/lib/chrony"

# Always overwrite sample preseeds to ensure samples are up-to-date in case
# we do changes that need to be reflected.
cp "$SNAP/etc/maas/preseeds/curtin_userdata" "$SNAP_DATA/preseeds/curtin_userdata.sample"
cp "$SNAP/etc/maas/preseeds/curtin_userdata_centos" "$SNAP_DATA/preseeds/curtin_userdata_centos.sample"
cp "$SNAP/etc/maas/preseeds/curtin_userdata_custom" "$SNAP_DATA/preseeds/curtin_userdata_custom.sample"
cp "$SNAP/etc/maas/preseeds/curtin_userdata_windows" "$SNAP_DATA/preseeds/curtin_userdata_windows.sample"

if [ ! -e "$SNAP_COMMON/postgres" ]; then
    mkdir -m 770 "$SNAP_COMMON/postgres"
    chgrp snap_daemon "$SNAP_COMMON/postgres"
    mkdir "$SNAP_COMMON/postgres/"{data,sockets}
    chown snap_daemon.snap_daemon "$SNAP_COMMON/postgres/"{data,sockets}
fi

# ensure that services are running as migration needs running postgres
snapctl start "${SNAP_INSTANCE_NAME}.supervisor"

# Perform migrations. Does nothing in 'rack' or 'none' mode.
"$SNAP/bin/maas-wrapper" migrate --configure
# Force reconfigure of supervisord as config template might have changed
"$SNAP/bin/maas-wrapper" reconfigure-supervisord
